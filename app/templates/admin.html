<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEDUC - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .admin-card {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .admin-card h2 {
            color: #dc3545;
            margin-bottom: 1rem;
            border-bottom: 2px solid #dc3545;
            padding-bottom: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            background: none;
            border: none;
            font-size: 1rem;
        }

        .tab.active {
            border-bottom-color: #dc3545;
            color: #dc3545;
            font-weight: 600;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-box input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 200px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-buttons button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            align-items: center;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .pagination button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .pagination button:hover:not(.active) {
            background: #f8f9fa;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            margin: 0 1rem;
            color: #666;
            font-size: 0.9rem;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .page-size-selector select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .container {
                padding: 0 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔧 SEDUC - Painel Administrativo</h1>
        <div class="user-info">
            <span id="username">Admin</span>
            <a href="/dashboard" class="btn">Dashboard</a>
            <button class="btn" onclick="logout()">Sair</button>
        </div>
    </div>

    <div class="container">
        <div id="alert" class="alert"></div>

        <div class="admin-card">
            <h2>Gerenciamento de Dados</h2>
            <p>Gerencie todos os dados do sistema SEDUC.</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">-</h3>
                    <p>Usuários</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalSchools">-</h3>
                    <p>Escolas</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalStudents">-</h3>
                    <p>Alunos</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalSubjects">-</h3>
                    <p>Disciplinas</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalEnrollments">-</h3>
                    <p>Matrículas</p>
                </div>
            </div>
        </div>

        <div class="admin-card">
            <div class="tabs">
                <button class="tab active" onclick="showTab('users')">Usuários</button>
                <button class="tab" onclick="showTab('schools')">Escolas</button>
                <button class="tab" onclick="showTab('students')">Alunos</button>
                <button class="tab" onclick="showTab('subjects')">Disciplinas</button>
                <button class="tab" onclick="showTab('enrollments')">Matrículas</button>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content active">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="userSearchInput" placeholder="Buscar usuários..." onkeyup="filterData('users')">
                        <button class="btn-primary" onclick="filterData('users')">Buscar</button>
                    </div>
                    <button class="btn-success" onclick="openCreateModal('users')">+ Novo Usuário</button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome de Usuário</th>
                                <th>Email</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Data de Criação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- User data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="userPagination">
                    <!-- Pagination controls will be added here -->
                </div>
            </div>

            <!-- Schools Tab -->
            <div id="schools" class="tab-content">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="schoolSearchInput" placeholder="Buscar escolas..." onkeyup="filterData('schools')">
                        <button class="btn-primary" onclick="filterData('schools')">Buscar</button>
                    </div>
                    <button class="btn-success" onclick="openCreateModal('schools')">+ Nova Escola</button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Endereço</th>
                                <th>Cidade</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="schoolTableBody">
                            <!-- School data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="schoolPagination">
                    <!-- Pagination controls will be added here -->
                </div>
            </div>

            <!-- Students Tab -->
            <div id="students" class="tab-content">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="studentSearchInput" placeholder="Buscar alunos..." onkeyup="filterData('students')">
                        <button class="btn-primary" onclick="filterData('students')">Buscar</button>
                    </div>
                    <button class="btn-success" onclick="openCreateModal('students')">+ Novo Aluno</button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Matrícula</th>
                                <th>Nome</th>
                                <th>Data de Matrícula</th>
                                <th>Turno</th>
                                <th>Série</th>
                                <th>Escola</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <!-- Student data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="studentPagination">
                    <!-- Pagination controls will be added here -->
                </div>
            </div>

            <!-- Subjects Tab -->
            <div id="subjects" class="tab-content">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="subjectSearchInput" placeholder="Buscar disciplinas..." onkeyup="filterData('subjects')">
                        <button class="btn-primary" onclick="filterData('subjects')">Buscar</button>
                    </div>
                    <button class="btn-success" onclick="openCreateModal('subjects')">+ Nova Disciplina</button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="subjectTableBody">
                            <!-- Subject data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="subjectPagination">
                    <!-- Pagination controls will be added here -->
                </div>
            </div>

            <!-- Enrollments Tab -->
            <div id="enrollments" class="tab-content">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="enrollmentSearchInput" placeholder="Buscar matrículas..." onkeyup="filterData('enrollments')">
                        <button class="btn-primary" onclick="filterData('enrollments')">Buscar</button>
                    </div>
                    <button class="btn-success" onclick="openCreateModal('enrollments')">+ Nova Matrícula</button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ano</th>
                                <th>Aluno</th>
                                <th>Escola</th>
                                <th>Disciplina</th>
                                <th>Série</th>
                                <th>Nota</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="enrollmentTableBody">
                            <!-- Enrollment data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="enrollmentPagination">
                    <!-- Pagination controls will be added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Modal for all forms -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Novo Registro</h2>
            
            <form id="dataForm">
                <div id="formFields">
                    <!-- Form fields will be dynamically generated here -->
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check if user is logged in and is admin
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || !user.id) {
            window.location.href = '/login';
        }

        // Check if user is admin
        if (!user.is_admin) {
            showAlert('Acesso negado. Apenas administradores podem acessar esta página.', 'error');
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 2000);
        }

        // Display user information
        document.getElementById('username').textContent = user.username || 'Admin';
        
        // Global variables
        let currentData = {
            users: [],
            schools: [],
            students: [],
            subjects: [],
            enrollments: []
        };
        let filteredData = {
            users: [],
            schools: [],
            students: [],
            subjects: [],
            enrollments: []
        };
        let currentTab = 'users';
        let editingId = null;
        
        // Pagination variables
        let paginationState = {
            users: { currentPage: 1, pageSize: 10, totalItems: 0, totalPages: 0 },
            schools: { currentPage: 1, pageSize: 10, totalItems: 0, totalPages: 0 },
            students: { currentPage: 1, pageSize: 10, totalItems: 0, totalPages: 0 },
            subjects: { currentPage: 1, pageSize: 10, totalItems: 0, totalPages: 0 },
            enrollments: { currentPage: 1, pageSize: 10, totalItems: 0, totalPages: 0 }
        };

        // Initialize the page
        loadAllData();
        loadStats();
        
        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            loadStats();
        });
        


        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        async function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // Load data for the selected tab with server-side pagination
            await loadTabData(tabName, 1, paginationState[tabName].pageSize);
        }

        async function loadAllData() {
            try {
                // Load stats data (total counts) for the dashboard
                const [usersRes, schoolsRes, studentsRes, subjectsRes, enrollmentsRes] = await Promise.all([
                    fetch('/api/users?page=1&per_page=1', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/escolas?page=1&per_page=1', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/alunos?page=1&per_page=1', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/disciplinas?page=1&per_page=1', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/matriculas?page=1&per_page=1', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                // Extract total counts from pagination info
                if (usersRes.ok) {
                    const userData = await usersRes.json();
                    currentData.users = userData.pagination ? userData.pagination.total : 0;
                }
                if (schoolsRes.ok) {
                    const schoolData = await schoolsRes.json();
                    currentData.schools = schoolData.pagination ? schoolData.pagination.total : 0;
                }
                if (studentsRes.ok) {
                    const studentData = await studentsRes.json();
                    currentData.students = studentData.pagination ? studentData.pagination.total : 0;
                }
                if (subjectsRes.ok) {
                    const subjectData = await subjectsRes.json();
                    currentData.subjects = subjectData.pagination ? subjectData.pagination.total : 0;
                }
                if (enrollmentsRes.ok) {
                    const enrollmentData = await enrollmentsRes.json();
                    currentData.enrollments = enrollmentData.pagination ? enrollmentData.pagination.total : 0;
                }

                // Load initial data for current tab
                await loadTabData(currentTab);
            } catch (error) {
                console.error('Failed to load data:', error);
                showAlert('Erro ao carregar dados', 'error');
            }
        }

        async function loadStats() {
            try {
                const stats = {
                    users: currentData.users || 0,
                    schools: currentData.schools || 0,
                    students: currentData.students || 0,
                    subjects: currentData.subjects || 0,
                    enrollments: currentData.enrollments || 0
                };

                document.getElementById('totalUsers').textContent = stats.users;
                document.getElementById('totalSchools').textContent = stats.schools;
                document.getElementById('totalStudents').textContent = stats.students;
                document.getElementById('totalSubjects').textContent = stats.subjects;
                document.getElementById('totalEnrollments').textContent = stats.enrollments;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadTabData(type, page = 1, perPage = 10, search = '') {
            try {
                const endpoints = {
                    'users': '/api/users',
                    'schools': '/api/escolas',
                    'students': '/api/alunos',
                    'subjects': '/api/disciplinas',
                    'enrollments': '/api/matriculas'
                };
                
                const url = new URL(endpoints[type], window.location.origin);
                url.searchParams.set('page', page);
                url.searchParams.set('per_page', perPage);
                if (search) {
                    url.searchParams.set('search', search);
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Map the response structure to match the expected format
                    let items = [];
                    const responseMapping = {
                        'users': 'users',
                        'schools': 'escolas', 
                        'students': 'students',
                        'subjects': 'disciplinas',
                        'enrollments': 'enrollments'
                    };
                    
                    const dataKey = responseMapping[type];
                    if (dataKey && data[dataKey]) {
                        items = data[dataKey];
                    } else if (Array.isArray(data)) {
                        items = data;
                    } else {
                        console.warn(`Unexpected data structure for ${type}:`, data);
                        items = [];
                    }
                    
                    const pagination = data.pagination;
                    
                    // Ensure items is always an array
                    if (!Array.isArray(items)) {
                        console.error(`Items for ${type} is not an array:`, items);
                        items = [];
                    }
                    
                    // Update filteredData with the items
                    filteredData[type] = items;
                    
                    // Update pagination state
                    if (pagination) {
                        paginationState[type].currentPage = pagination.page;
                        paginationState[type].pageSize = pagination.per_page;
                        paginationState[type].totalItems = pagination.total;
                        if (type === 'enrollments') {
                            paginationState[type].totalPages = pagination.total_pages;
                        } else {
                            paginationState[type].totalPages = pagination.pages;
                        }
                    }
                    
                    // Display the data
                    displayData(type, false);
                    
                    return { items, pagination };
                } else {
                    console.error(`Failed to load ${type}:`, response.status);
                    return { items: [], pagination: null };
                }
            } catch (error) {
                console.error(`Error loading ${type}:`, error);
                return { items: [], pagination: null };
            }
        }

        async function filterData(type) {
            const searchInput = document.getElementById(`${type.slice(0, -1)}SearchInput`);
            const searchTerm = searchInput.value;
            
            // Reset to first page when filtering
            paginationState[type].currentPage = 1;
            
            // Load data with search using server-side pagination
            await loadTabData(type, 1, paginationState[type].pageSize, searchTerm);
        }

        function displayData(type, resetPage = false) {
            const tableBody = document.getElementById(`${type.slice(0, -1)}TableBody`);
            const pagination = document.getElementById(`${type.slice(0, -1)}Pagination`);
            
            // Ensure filteredData[type] exists
            if (!filteredData[type]) {
                filteredData[type] = [];
            }
            
            // Get pagination info from state
            const currentPage = paginationState[type].currentPage;
            const pageSize = paginationState[type].pageSize;
            
            // Get total items and pages from pagination state (set by loadTabData)
            const totalItems = paginationState[type].totalItems || filteredData[type].length;
            const totalPages = paginationState[type].totalPages || Math.ceil(totalItems / pageSize);
            
            if (!tableBody) {
                console.error(`Table body not found for ${type}`);
                return;
            }
            
            tableBody.innerHTML = '';

            try {
                filteredData[type].forEach(item => {
                    const row = document.createElement('tr');
                    
                    switch (type) {
                        case 'users':
                            row.innerHTML = `
                                <td>${item.id}</td>
                                <td>${item.username}</td>
                                <td>${item.email || '-'}</td>
                                <td>${item.is_admin ? 'Administrador' : 'Usuário Comum'}</td>
                                <td>${item.is_active ? 'Ativo' : 'Inativo'}</td>
                                <td>${new Date(item.created_at).toLocaleDateString('pt-BR')}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-warning" onclick="editItem('${type}', ${item.id})">Editar</button>
                                        <button class="btn-danger" onclick="deleteItem('${type}', ${item.id})">Excluir</button>
                                    </div>
                                </td>
                            `;
                            break;
                        case 'schools':
                            row.innerHTML = `
                                <td>${item.id_escola}</td>
                                <td>${item.nome}</td>
                                <td>${item.endereco}</td>
                                <td>${item.cidade}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-warning" onclick="editItem('${type}', ${item.id_escola})">Editar</button>
                                        <button class="btn-danger" onclick="deleteItem('${type}', ${item.id_escola})">Excluir</button>
                                    </div>
                                </td>
                            `;
                            break;
                        case 'students':
                            row.innerHTML = `
                                <td>${item.matricula}</td>
                                <td>${item.nome}</td>
                                <td>${new Date(item.data_mat).toLocaleDateString('pt-BR')}</td>
                                <td>${item.turno}</td>
                                <td>${item.serie}</td>
                                <td>${item.escola_nome || 'N/A'}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-warning" onclick="editItem('${type}', ${item.matricula})">Editar</button>
                                        <button class="btn-danger" onclick="deleteItem('${type}', ${item.matricula})">Excluir</button>
                                    </div>
                                </td>
                            `;
                            break;
                        case 'subjects':
                            row.innerHTML = `
                                <td>${item.id_disciplina}</td>
                                <td>${item.nome}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-warning" onclick="editItem('${type}', ${item.id_disciplina})">Editar</button>
                                        <button class="btn-danger" onclick="deleteItem('${type}', ${item.id_disciplina})">Excluir</button>
                                    </div>
                                </td>
                            `;
                            break;
                        case 'enrollments':
                            row.innerHTML = `
                                <td>${item.id}</td>
                                <td>${item.ano}</td>
                                <td>${item.aluno_nome || 'N/A'}</td>
                                <td>${item.escola_nome || 'N/A'}</td>
                                <td>${item.disciplina_nome || 'N/A'}</td>
                                <td>${item.serie}</td>
                                <td>${item.nota}</td>
                                <td>${item.status ? 'Aprovado' : 'Reprovado'}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-warning" onclick="editItem('${type}', ${item.id})">Editar</button>
                                        <button class="btn-danger" onclick="deleteItem('${type}', ${item.id})">Excluir</button>
                                    </div>
                                </td>
                            `;
                            break;
                    }
                    
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error(`Error displaying data for ${type}:`, error);
                tableBody.innerHTML = '<tr><td colspan="7">Erro ao carregar dados</td></tr>';
            }
            
            // Generate pagination controls
            try {
                generatePagination(type, totalPages, currentPage, totalItems, pageSize);
            } catch (error) {
                console.error(`Error generating pagination for ${type}:`, error);
                const pagination = document.getElementById(`${type.slice(0, -1)}Pagination`);
                if (pagination) {
                    pagination.innerHTML = '<span class="pagination-info">Erro na paginação</span>';
                }
            }
            
            // Ensure pagination is always shown (fallback)
            setTimeout(() => {
                const pagination = document.getElementById(`${type.slice(0, -1)}Pagination`);
                if (pagination && pagination.innerHTML.trim() === '') {
                    console.log(`Pagination was empty for ${type}, generating fallback`);
                    generatePagination(type, totalPages, currentPage, totalItems, pageSize);
                }
            }, 100);
        }

        function generatePagination(type, totalPages, currentPage, totalItems, pageSize) {
            const pagination = document.getElementById(`${type.slice(0, -1)}Pagination`);
            
            if (!pagination) {
                console.error(`Pagination element not found for ${type}`);
                return;
            }
            
            const startItem = totalPages <= 1 ? 1 : (currentPage - 1) * pageSize + 1;
            const endItem = totalPages <= 1 ? totalItems : Math.min(currentPage * pageSize, totalItems);
            
            // Always show pagination info and page size selector
            let paginationHTML = `
                <span class="pagination-info">
                    Mostrando ${startItem}-${endItem} de ${totalItems} registros
                </span>
                <div class="page-size-selector">
                    <label>Por página:</label>
                    <select onchange="changePageSize('${type}', this.value)">
                        <option value="5" ${pageSize === 5 ? 'selected' : ''}>5</option>
                        <option value="10" ${pageSize === 10 ? 'selected' : ''}>10</option>
                        <option value="25" ${pageSize === 25 ? 'selected' : ''}>25</option>
                        <option value="50" ${pageSize === 50 ? 'selected' : ''}>50</option>
                    </select>
                </div>
            `;
            
            if (totalPages <= 1) {
                pagination.innerHTML = paginationHTML;
                return;
            }
            
            paginationHTML = `
                <button onclick="changePage('${type}', 1)" ${currentPage === 1 ? 'disabled' : ''}>
                    Primeira
                </button>
                <button onclick="changePage('${type}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    Anterior
                </button>
            `;
            
            // Add page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="changePage('${type}', ${i})" class="${i === currentPage ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            paginationHTML += `
                <button onclick="changePage('${type}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Próximo
                </button>
                <button onclick="changePage('${type}', ${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Última
                </button>
                <span class="pagination-info">
                    Mostrando ${startItem}-${endItem} de ${totalItems} registros
                </span>
                <div class="page-size-selector">
                    <label>Por página:</label>
                    <select onchange="changePageSize('${type}', this.value)">
                        <option value="5" ${pageSize === 5 ? 'selected' : ''}>5</option>
                        <option value="10" ${pageSize === 10 ? 'selected' : ''}>10</option>
                        <option value="25" ${pageSize === 25 ? 'selected' : ''}>25</option>
                        <option value="50" ${pageSize === 50 ? 'selected' : ''}>50</option>
                    </select>
                </div>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        async function changePage(type, page) {
            paginationState[type].currentPage = page;
            
            const searchInput = document.getElementById(`${type.slice(0, -1)}SearchInput`);
            const searchTerm = searchInput ? searchInput.value : '';
            
            await loadTabData(type, page, paginationState[type].pageSize, searchTerm);
        }

        async function changePageSize(type, newSize) {
            paginationState[type].pageSize = parseInt(newSize);
            paginationState[type].currentPage = 1; // Reset to first page when changing page size
            
            const searchInput = document.getElementById(`${type.slice(0, -1)}SearchInput`);
            const searchTerm = searchInput ? searchInput.value : '';
            
            await loadTabData(type, 1, newSize, searchTerm);
        }

        async function loadRelatedData() {
            try {
                console.log('Loading related data...');
                
                // Load schools for dropdowns
                const schoolsRes = await fetch('/api/escolas?page=1&per_page=100', { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                if (schoolsRes.ok) {
                    const schoolData = await schoolsRes.json();
                    currentData.allSchools = schoolData.escolas || [];
                    console.log('Loaded schools:', currentData.allSchools.length);
                }
                
                // Load students for dropdowns
                const studentsRes = await fetch('/api/alunos?page=1&per_page=100', { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                if (studentsRes.ok) {
                    const studentData = await studentsRes.json();
                    currentData.allStudents = studentData.students || [];
                    console.log('Loaded students:', currentData.allStudents.length);
                }
                
                // Load subjects for dropdowns
                const subjectsRes = await fetch('/api/disciplinas?page=1&per_page=100', { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                if (subjectsRes.ok) {
                    const subjectData = await subjectsRes.json();
                    currentData.allSubjects = subjectData.disciplinas || [];
                    console.log('Loaded subjects:', currentData.allSubjects.length);
                }
            } catch (error) {
                console.error('Failed to load related data:', error);
            }
        }

        async function openCreateModal(type) {
            editingId = null;
            document.getElementById('modalTitle').textContent = `Novo ${getTypeName(type)}`;
            document.getElementById('dataForm').reset();
            
            // Load related data for dropdowns
            await loadRelatedData();
            
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = generateFormFields(type);
            
            document.getElementById('dataModal').style.display = 'block';
        }

        async function editItem(type, id) {
            editingId = id;
            const item = filteredData[type].find(item => {
                switch (type) {
                    case 'users': return item.id === id;
                    case 'schools': return item.id_escola === id;
                    case 'students': return item.matricula === id;
                    case 'subjects': return item.id_disciplina === id;
                    case 'enrollments': return item.id === id;
                }
            });
            
            if (!item) return;

            document.getElementById('modalTitle').textContent = `Editar ${getTypeName(type)}`;
            
            // Load related data for dropdowns
            await loadRelatedData();
            
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = generateFormFields(type, item);
            
            // Populate form with existing data
            Object.keys(item).forEach(key => {
                const input = document.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = item[key];
                }
            });
            
            document.getElementById('dataModal').style.display = 'block';
        }

        function generateFormFields(type, item = null) {
            switch (type) {
                case 'users':
                    return `
                        ${item ? `<input type="hidden" name="id" value="${item.id}">` : ''}
                        <div class="form-group">
                            <label for="username">Nome de Usuário:</label>
                            <input type="text" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" name="email">
                        </div>
                        <div class="form-group">
                            <label for="password">Senha:</label>
                            <input type="password" name="password" ${!item ? 'required' : ''}>
                            ${item ? '<small style="color: #666;">Deixe em branco para manter a senha atual</small>' : ''}
                        </div>
                        <div class="form-group">
                            <label for="is_admin">Tipo de Usuário:</label>
                            <select name="is_admin" required>
                                <option value="false">Usuário Comum</option>
                                <option value="true">Administrador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="is_active">Status:</label>
                            <select name="is_active" required>
                                <option value="true">Ativo</option>
                                <option value="false">Inativo</option>
                            </select>
                        </div>
                    `;
                case 'schools':
                    return `
                        ${item ? `<input type="hidden" name="id_escola" value="${item.id_escola}">` : ''}
                        <div class="form-group">
                            <label for="nome">Nome da Escola:</label>
                            <input type="text" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label for="endereco">Endereço:</label>
                            <input type="text" name="endereco" required>
                        </div>
                        <div class="form-group">
                            <label for="cidade">Cidade:</label>
                            <input type="text" name="cidade" required>
                        </div>
                    `;
                case 'students':
                    return `
                        ${item ? `<input type="hidden" name="matricula" value="${item.matricula}">` : ''}
                        <div class="form-group">
                            <label for="nome">Nome do Aluno:</label>
                            <input type="text" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label for="data_mat">Data de Matrícula:</label>
                            <input type="date" name="data_mat" required>
                        </div>
                        <div class="form-group">
                            <label for="turno">Turno:</label>
                            <select name="turno" required>
                                <option value="Manhã">Manhã</option>
                                <option value="Tarde">Tarde</option>
                                <option value="Noite">Noite</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serie">Série:</label>
                            <select name="serie" required>
                                <option value="1">1º Ano</option>
                                <option value="2">2º Ano</option>
                                <option value="3">3º Ano</option>
                                <option value="4">4º Ano</option>
                                <option value="5">5º Ano</option>
                                <option value="6">6º Ano</option>
                                <option value="7">7º Ano</option>
                                <option value="8">8º Ano</option>
                                <option value="9">9º Ano</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="id_escola">Escola:</label>
                            <select name="id_escola" required>
                                <option value="">Selecione uma escola</option>
                                ${currentData.allSchools.map(school => 
                                    `<option value="${school.id_escola}">${school.nome} - ${school.cidade}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                case 'subjects':
                    return `
                        ${item ? `<input type="hidden" name="id_disciplina" value="${item.id_disciplina}">` : ''}
                        <div class="form-group">
                            <label for="nome">Nome da Disciplina:</label>
                            <input type="text" name="nome" required>
                        </div>
                    `;
                case 'enrollments':
                    return `
                        ${item ? `<input type="hidden" name="id" value="${item.id}">` : ''}
                        <div class="form-group">
                            <label for="ano">Ano:</label>
                            <input type="number" name="ano" min="2020" max="2030" required>
                        </div>
                        <div class="form-group">
                            <label for="matricula_aluno">Aluno:</label>
                            <select name="matricula_aluno" required>
                                <option value="">Selecione um aluno</option>
                                ${currentData.allStudents ? currentData.allStudents.map(student => 
                                    `<option value="${student.matricula}">${student.nome} (${student.matricula})</option>`
                                ).join('') : '<option value="">Carregando alunos...</option>'}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="id_escola">Escola:</label>
                            <select name="id_escola" required>
                                <option value="">Selecione uma escola</option>
                                ${currentData.allSchools ? currentData.allSchools.map(school => 
                                    `<option value="${school.id_escola}">${school.nome} - ${school.cidade}</option>`
                                ).join('') : '<option value="">Carregando escolas...</option>'}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="id_disciplina">Disciplina:</label>
                            <select name="id_disciplina" required>
                                <option value="">Selecione uma disciplina</option>
                                ${currentData.allSubjects ? currentData.allSubjects.map(subject => 
                                    `<option value="${subject.id_disciplina}">${subject.nome}</option>`
                                ).join('') : '<option value="">Carregando disciplinas...</option>'}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serie">Série:</label>
                            <select name="serie" required>
                                <option value="1">1º Ano</option>
                                <option value="2">2º Ano</option>
                                <option value="3">3º Ano</option>
                                <option value="4">4º Ano</option>
                                <option value="5">5º Ano</option>
                                <option value="6">6º Ano</option>
                                <option value="7">7º Ano</option>
                                <option value="8">8º Ano</option>
                                <option value="9">9º Ano</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="nota">Nota:</label>
                            <input type="number" name="nota" min="0" max="10" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select name="status" required>
                                <option value="true">Aprovado</option>
                                <option value="false">Reprovado</option>
                            </select>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        function getTypeName(type) {
            const names = {
                'users': 'Usuário',
                'schools': 'Escola',
                'students': 'Aluno',
                'subjects': 'Disciplina',
                'enrollments': 'Matrícula'
            };
            return names[type] || 'Registro';
        }

        function closeModal() {
            document.getElementById('dataModal').style.display = 'none';
            editingId = null;
        }

        async function deleteItem(type, id) {
            if (!confirm(`Tem certeza que deseja excluir este ${getTypeName(type)}?`)) return;

            try {
                const endpoints = {
                    'users': `/api/users/${id}`,
                    'schools': `/api/escolas/${id}`,
                    'students': `/api/alunos/${id}`,
                    'subjects': `/api/disciplinas/${id}`,
                    'enrollments': `/api/matriculas/${id}`
                };

                const response = await fetch(endpoints[type], {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showAlert(`${getTypeName(type)} excluído com sucesso`, 'success');
                    loadAllData();
                    loadStats();
                } else {
                    showAlert(`Erro ao excluir ${getTypeName(type)}`, 'error');
                }
            } catch (error) {
                console.error('Failed to delete item:', error);
                showAlert(`Erro ao excluir ${getTypeName(type)}`, 'error');
            }
        }

        // Handle form submission
        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Convert boolean strings to actual booleans
            if (data.is_admin !== undefined) data.is_admin = data.is_admin === 'true';
            if (data.is_active !== undefined) data.is_active = data.is_active === 'true';
            if (data.status !== undefined) data.status = data.status === 'true';
            
            // Convert numeric fields
            if (data.serie) data.serie = parseInt(data.serie);
            if (data.ano) data.ano = parseInt(data.ano);
            if (data.nota) data.nota = parseFloat(data.nota);
            if (data.id_escola) data.id_escola = parseInt(data.id_escola);
            if (data.id_disciplina) data.id_disciplina = parseInt(data.id_disciplina);
            if (data.matricula_aluno) data.matricula_aluno = parseInt(data.matricula_aluno);
            
            const isEdit = editingId !== null;
            
            try {
                const endpoints = {
                    'users': isEdit ? `/api/users/${editingId}` : '/api/users',
                    'schools': isEdit ? `/api/escolas/${editingId}` : '/api/escolas',
                    'students': isEdit ? `/api/alunos/${editingId}` : '/api/alunos',
                    'subjects': isEdit ? `/api/disciplinas/${editingId}` : '/api/disciplinas',
                    'enrollments': isEdit ? `/api/matriculas/${editingId}` : '/api/matriculas'
                };

                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(endpoints[currentTab], {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert(`${getTypeName(currentTab)} ${isEdit ? 'atualizado' : 'criado'} com sucesso`, 'success');
                    closeModal();
                    loadAllData();
                    loadStats();
                } else {
                    const error = await response.json();
                    showAlert(error.message || `Erro ao salvar ${getTypeName(currentTab)}`, 'error');
                }
            } catch (error) {
                console.error('Failed to save item:', error);
                showAlert(`Erro ao salvar ${getTypeName(currentTab)}`, 'error');
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('dataModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Verify token validity periodically
        setInterval(async () => {
            try {
                const response = await fetch('/api/auth/verify-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token
                    })
                });

                if (!response.ok) {
                    logout();
                }
            } catch (error) {
                console.error('Token verification failed:', error);
            }
        }, 300000); // Check every 5 minutes


    </script>
</body>
</html> 